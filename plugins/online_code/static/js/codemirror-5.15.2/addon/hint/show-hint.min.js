(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror"],a)}else{a(CodeMirror)}}})(function(e){var i="CodeMirror-hint";var h="CodeMirror-hint-active";e.showHint=function(q,r,s){if(!r){return q.showHint(s)}if(s&&s.async){r.async=true}var t={hint:r};if(s){for(var u in s){t[u]=s[u]}}return q.showHint(t)};e.defineExtension("showHint",function(r){r=o(this,this.getCursor("start"),r);var t=this.listSelections();if(t.length>1){return}if(this.somethingSelected()){if(!r.hint.supportsSelection){return}for(var s=0;s<t.length;s++){if(t[s].head.line!=t[s].anchor.line){return}}}if(this.state.completionActive){this.state.completionActive.close()}var q=this.state.completionActive=new b(this,r);if(!q.options.hint){return}e.signal(this,"startCompletion",this);q.update(true)});function b(q,s){this.cm=q;this.options=s;this.widget=null;this.debounce=0;this.tick=0;this.startPos=this.cm.getCursor("start");this.startLen=this.cm.getLine(this.startPos.line).length-this.cm.getSelection().length;var r=this;q.on("cursorActivity",this.activityFunc=function(){r.cursorActivity()})}var l=window.requestAnimationFrame||function(q){return setTimeout(q,1000/60)};var g=window.cancelAnimationFrame||clearTimeout;b.prototype={close:function(){if(!this.active()){return}this.cm.state.completionActive=null;this.tick=null;this.cm.off("cursorActivity",this.activityFunc);if(this.widget&&this.data){e.signal(this.data,"close")}if(this.widget){this.widget.close()}e.signal(this.cm,"endCompletion",this.cm)},active:function(){return this.cm.state.completionActive==this},pick:function(s,r){var q=s.list[r];if(q.hint){q.hint(this.cm,s,q)}else{this.cm.replaceRange(p(q),q.from||s.from,q.to||s.to,"complete")}e.signal(s,"pick",q);this.close()},cursorActivity:function(){if(this.debounce){g(this.debounce);this.debounce=0}var s=this.cm.getCursor(),q=this.cm.getLine(s.line);if(s.line!=this.startPos.line||q.length-s.ch!=this.startLen-this.startPos.ch||s.ch<this.startPos.ch||this.cm.somethingSelected()||(s.ch&&this.options.closeCharacters.test(q.charAt(s.ch-1)))){this.close()}else{var r=this;this.debounce=l(function(){r.update()});if(this.widget){this.widget.disable()}}},update:function(s){if(this.tick==null){return}var q=this,r=++this.tick;f(this.options.hint,this.cm,this.options,function(t){if(q.tick==r){q.finishUpdate(t,s)}})},finishUpdate:function(r,s){if(this.data){e.signal(this.data,"update")}var q=(this.widget&&this.widget.picked)||(s&&this.options.completeSingle);if(this.widget){this.widget.close()}if(r&&this.data&&j(this.data,r)){return}this.data=r;if(r&&r.list.length){if(q&&r.list.length==1){this.pick(r,0)}else{this.widget=new n(this,r);e.signal(r,"shown")}}}};function j(r,q){var s=e.cmpPos(q.from,r.from);return s>0&&r.to.ch-r.from.ch!=q.to.ch-q.from.ch}function o(q,v,s){var t=q.options.hintOptions;var r={};for(var u in c){r[u]=c[u]}if(t){for(var u in t){if(t[u]!==undefined){r[u]=t[u]}}}if(s){for(var u in s){if(s[u]!==undefined){r[u]=s[u]}}}if(r.hint.resolve){r.hint=r.hint.resolve(q,v)}return r}function p(q){if(typeof q=="string"){return q}else{return q.text}}function d(u,x){var r={Up:function(){x.moveFocus(-1)},Down:function(){x.moveFocus(1)},PageUp:function(){x.moveFocus(-x.menuSize()+1,true)},PageDown:function(){x.moveFocus(x.menuSize()-1,true)},Home:function(){x.setFocus(0)},End:function(){x.setFocus(x.length-1)},Enter:x.pick,Tab:x.pick,Esc:x.close};var w=u.options.customKeys;var t=w?{}:r;function s(y,A){var z;if(typeof A!="string"){z=function(B){return A(B,x)}}else{if(r.hasOwnProperty(A)){z=r[A]}else{z=A}}t[y]=z}if(w){for(var v in w){if(w.hasOwnProperty(v)){s(v,w[v])}}}var q=u.options.extraKeys;if(q){for(var v in q){if(q.hasOwnProperty(v)){s(v,q[v])}}}return t}function m(r,q){while(q&&q!=r){if(q.nodeName.toUpperCase()==="LI"&&q.parentNode==r){return q}q=q.parentNode}}function n(D,N){this.completion=D;this.data=N;this.picked=false;var u=this,z=D.cm;var K=this.hints=document.createElement("ul");K.className="CodeMirror-hints";this.selectedHint=N.selectedHint||0;var y=N.list;for(var M=0;M<y.length;++M){var t=K.appendChild(document.createElement("li")),s=y[M];var r=i+(M!=this.selectedHint?"":" "+h);if(s.className!=null){r=s.className+" "+r}t.className=r;if(s.render){s.render(t,N,s)}else{t.appendChild(document.createTextNode(s.displayText||p(s)))}t.hintId=M}var x=z.cursorCoords(D.options.alignWithWord?N.from:null);var v=x.left,H=x.bottom,F=true;K.style.left=v+"px";K.style.top=H+"px";var A=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth);var L=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight);(D.options.container||document.body).appendChild(K);var B=K.getBoundingClientRect(),C=B.bottom-L;if(C>0){var I=B.bottom-B.top,q=x.top-(x.bottom-B.top);if(q-I>0){K.style.top=(H=x.top-I)+"px";F=false}else{if(I>L){K.style.height=(L-5)+"px";K.style.top=(H=x.bottom-B.top)+"px";var w=z.getCursor();if(N.from.ch!=w.ch){x=z.cursorCoords(w);K.style.left=(v=x.left)+"px";B=K.getBoundingClientRect()}}}}var E=B.right-A;if(E>0){if(B.right-B.left>A){K.style.width=(A-5)+"px";E-=(B.right-B.left)-A}K.style.left=(v=x.left-E)+"px"}z.addKeyMap(this.keyMap=d(D,{moveFocus:function(P,O){u.changeActive(u.selectedHint+P,O)},setFocus:function(O){u.changeActive(O)},menuSize:function(){return u.screenAmount()},length:y.length,close:function(){D.close()},pick:function(){u.pick()},data:N}));if(D.options.closeOnUnfocus){var J;z.on("blur",this.onBlur=function(){J=setTimeout(function(){D.close()},100)});z.on("focus",this.onFocus=function(){clearTimeout(J)})}var G=z.getScrollInfo();z.on("scroll",this.onScroll=function(){var R=z.getScrollInfo(),Q=z.getWrapperElement().getBoundingClientRect();var P=H+G.top-R.top;var O=P-(window.pageYOffset||(document.documentElement||document.body).scrollTop);if(!F){O+=K.offsetHeight}if(O<=Q.top||O>=Q.bottom){return D.close()}K.style.top=P+"px";K.style.left=(v+G.left-R.left)+"px"});e.on(K,"dblclick",function(P){var O=m(K,P.target||P.srcElement);if(O&&O.hintId!=null){u.changeActive(O.hintId);u.pick()}});e.on(K,"click",function(P){var O=m(K,P.target||P.srcElement);if(O&&O.hintId!=null){u.changeActive(O.hintId);if(D.options.completeOnSingleClick){u.pick()}}});e.on(K,"mousedown",function(){setTimeout(function(){z.focus()},20)});e.signal(N,"select",y[0],K.firstChild);return true}n.prototype={close:function(){if(this.completion.widget!=this){return}this.completion.widget=null;this.hints.parentNode.removeChild(this.hints);this.completion.cm.removeKeyMap(this.keyMap);var q=this.completion.cm;if(this.completion.options.closeOnUnfocus){q.off("blur",this.onBlur);q.off("focus",this.onFocus)}q.off("scroll",this.onScroll)},disable:function(){this.completion.cm.removeKeyMap(this.keyMap);var q=this;this.keyMap={Enter:function(){q.picked=true}};this.completion.cm.addKeyMap(this.keyMap)},pick:function(){this.completion.pick(this.data,this.selectedHint)},changeActive:function(q,s){if(q>=this.data.list.length){q=s?this.data.list.length-1:0}else{if(q<0){q=s?0:this.data.list.length-1}}if(this.selectedHint==q){return}var r=this.hints.childNodes[this.selectedHint];r.className=r.className.replace(" "+h,"");r=this.hints.childNodes[this.selectedHint=q];r.className+=" "+h;if(r.offsetTop<this.hints.scrollTop){this.hints.scrollTop=r.offsetTop-3}else{if(r.offsetTop+r.offsetHeight>this.hints.scrollTop+this.hints.clientHeight){this.hints.scrollTop=r.offsetTop+r.offsetHeight-this.hints.clientHeight+3}}e.signal(this.data,"select",this.data.list[this.selectedHint],r)},screenAmount:function(){return Math.floor(this.hints.clientHeight/this.hints.firstChild.offsetHeight)||1}};function k(r,t){if(!r.somethingSelected()){return t}var q=[];for(var s=0;s<t.length;s++){if(t[s].supportsSelection){q.push(t[s])}}return q}function f(t,r,s,u){if(t.async){t(r,u,s)}else{var q=t(r,s);if(q&&q.then){q.then(u)}else{u(q)}}}function a(q,u){var s=q.getHelpers(u,"hint"),t;if(s.length){var r=function(v,z,w){var y=k(v,s);function x(A){if(A==y.length){return z(null)}f(y[A],v,w,function(B){if(B&&B.list.length>0){z(B)}else{x(A+1)}})}x(0)};r.async=true;r.supportsSelection=true;return r}else{if(t=q.getHelper(q.getCursor(),"hintWords")){return function(v){return e.hint.fromList(v,{words:t})}}else{if(e.hint.anyword){return function(v,w){return e.hint.anyword(v,w)}}else{return function(){}}}}}e.registerHelper("hint","auto",{resolve:a});e.registerHelper("hint","fromList",function(w,z){var x=w.getCursor(),r=w.getTokenAt(x);var u=e.Pos(x.line,r.end);if(r.string&&/\w/.test(r.string[r.string.length-1])){var s=r.string,v=e.Pos(x.line,r.start)}else{var s="",v=u}var y=[];for(var t=0;t<z.words.length;t++){var q=z.words[t];if(q.slice(0,s.length)==s){y.push(q)}}if(y.length){return{list:y,from:v,to:u}}});e.commands.autocomplete=e.showHint;var c={hint:e.hint.auto,completeSingle:true,alignWithWord:true,closeCharacters:/[\s()\[\]{};:>,]/,closeOnUnfocus:true,completeOnSingleClick:true,container:null,customKeys:null,extraKeys:null};e.defineOption("hintOptions",null)});