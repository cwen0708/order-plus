(function(a){if(typeof exports=="object"&&typeof module=="object"){a(require("../../lib/codemirror"),require("../xml/xml"),require("../meta"))}else{if(typeof define=="function"&&define.amd){define(["../../lib/codemirror","../xml/xml","../meta"],a)}else{a(CodeMirror)}}})(function(a){a.defineMode("markdown",function(F,n){var j=a.getMode(F,"text/html");var d=j.name=="null";function f(J){if(a.findModeByName){var K=a.findModeByName(J);if(K){J=K.mime||K.mimes[0]}}var L=a.getMode(F,J);return L.name=="null"?null:L}if(n.highlightFormatting===undefined){n.highlightFormatting=false}if(n.maxBlockquoteDepth===undefined){n.maxBlockquoteDepth=0}if(n.underscoresBreakWords===undefined){n.underscoresBreakWords=true}if(n.taskLists===undefined){n.taskLists=false}if(n.strikethrough===undefined){n.strikethrough=false}if(n.tokenTypeOverrides===undefined){n.tokenTypeOverrides={}}var p={header:"header",code:"comment",quote:"quote",list1:"variable-2",list2:"variable-3",list3:"keyword",hr:"hr",image:"tag",formatting:"formatting",linkInline:"link",linkEmail:"link",linkText:"link",linkHref:"string",em:"em",strong:"strong",strikethrough:"strikethrough"};for(var H in p){if(p.hasOwnProperty(H)&&n.tokenTypeOverrides[H]){p[H]=n.tokenTypeOverrides[H]}}var I=/^([*\-_])(?:\s*\1){2,}\s*$/,t=/^[*\-+]\s+/,y=/^[0-9]+([.)])\s+/,C=/^\[(x| )\](?=\s)/,o=n.allowAtxHeaderWithoutSpace?/^(#+)/:/^(#+)(?: |$)/,E=/^ *(?:\={1,}|-{1,})\s*$/,h=/^[^#!\[\]*_\\<>` "'(~]+/,D=new RegExp("^("+(n.fencedCodeBlocks===true?"~~~+|```+":n.fencedCodeBlocks)+")[ \\t]*([\\w+#-]*)");function g(L,K,J){K.f=K.inline=J;return J(L,K)}function v(L,K,J){K.f=K.block=J;return J(L,K)}function s(J){return !J||!/\S/.test(J.string)}function r(J){J.linkTitle=false;J.em=false;J.strong=false;J.strikethrough=false;J.quote=0;J.indentedCode=false;if(d&&J.f==z){J.f=u;J.block=m}J.trailingSpace=0;J.trailingSpaceNewLine=false;J.prevLine=J.thisLine;J.thisLine=null;return null}function m(P,O){var N=P.sol();var L=O.list!==false,J=O.indentedCode;O.indentedCode=false;if(L){if(O.indentationDiff>=0){if(O.indentationDiff<4){O.indentation-=O.indentationDiff}O.list=null}else{if(O.indentation>0){O.list=null}else{O.list=false}}}var K=null;if(O.indentationDiff>=4){P.skipToEnd();if(J||s(O.prevLine)){O.indentation-=4;O.indentedCode=true;return p.code}else{return null}}else{if(P.eatSpace()){return null}else{if((K=P.match(o))&&K[1].length<=6){O.header=K[1].length;if(n.highlightFormatting){O.formatting="header"}O.f=O.inline;return x(O)}else{if(!s(O.prevLine)&&!O.quote&&!L&&!J&&(K=P.match(E))){O.header=K[0].charAt(0)=="="?1:2;if(n.highlightFormatting){O.formatting="header"}O.f=O.inline;return x(O)}else{if(P.eat(">")){O.quote=N?1:O.quote+1;if(n.highlightFormatting){O.formatting="quote"}P.eatSpace();return x(O)}else{if(P.peek()==="["){return g(P,O,l)}else{if(P.match(I,true)){O.hr=true;return p.hr}else{if((s(O.prevLine)||L)&&(P.match(t,false)||P.match(y,false))){var M=null;if(P.match(t,true)){M="ul"}else{P.match(y,true);M="ol"}O.indentation=P.column()+P.current().length;O.list=true;while(O.listStack&&P.column()<O.listStack[O.listStack.length-1]){O.listStack.pop()}O.listStack.push(O.indentation);if(n.taskLists&&P.match(C,false)){O.taskList=true}O.f=O.inline;if(n.highlightFormatting){O.formatting=["list","list-"+M]}return x(O)}else{if(n.fencedCodeBlocks&&(K=P.match(D,true))){O.fencedChars=K[1];O.localMode=f(K[2]);if(O.localMode){O.localState=a.startState(O.localMode)}O.f=O.block=w;if(n.highlightFormatting){O.formatting="code-block"}O.code=-1;return x(O)}}}}}}}}}return g(P,O,O.inline)}function z(M,L){var K=j.token(M,L.htmlState);if(!d){var J=a.innerMode(j,L.htmlState);if((J.mode.name=="xml"&&J.state.tagStart===null&&(!J.state.context&&J.state.tokenize.isInText))||(L.md_inside&&M.current().indexOf(">")>-1)){L.f=u;L.block=m;L.htmlState=null}}return K}function w(K,J){if(J.fencedChars&&K.match(J.fencedChars,false)){J.localMode=J.localState=null;J.f=J.block=A;return null}else{if(J.localMode){return J.localMode.token(K,J.localState)}else{K.skipToEnd();return p.code}}}function A(L,K){L.match(K.fencedChars);K.block=m;K.f=u;K.fencedChars=null;if(n.highlightFormatting){K.formatting="code-block"}K.code=1;var J=x(K);K.code=0;return J}function x(M){var L=[];if(M.formatting){L.push(p.formatting);if(typeof M.formatting==="string"){M.formatting=[M.formatting]}for(var J=0;J<M.formatting.length;J++){L.push(p.formatting+"-"+M.formatting[J]);if(M.formatting[J]==="header"){L.push(p.formatting+"-"+M.formatting[J]+"-"+M.header)}if(M.formatting[J]==="quote"){if(!n.maxBlockquoteDepth||n.maxBlockquoteDepth>=M.quote){L.push(p.formatting+"-"+M.formatting[J]+"-"+M.quote)}else{L.push("error")}}}}if(M.taskOpen){L.push("meta");return L.length?L.join(" "):null}if(M.taskClosed){L.push("property");return L.length?L.join(" "):null}if(M.linkHref){L.push(p.linkHref,"url")}else{if(M.strong){L.push(p.strong)}if(M.em){L.push(p.em)}if(M.strikethrough){L.push(p.strikethrough)}if(M.linkText){L.push(p.linkText)}if(M.code){L.push(p.code)}}if(M.header){L.push(p.header,p.header+"-"+M.header)}if(M.quote){L.push(p.quote);if(!n.maxBlockquoteDepth||n.maxBlockquoteDepth>=M.quote){L.push(p.quote+"-"+M.quote)}else{L.push(p.quote+"-"+n.maxBlockquoteDepth)}}if(M.list!==false){var K=(M.listStack.length-1)%3;if(!K){L.push(p.list1)}else{if(K===1){L.push(p.list2)}else{L.push(p.list3)}}}if(M.trailingSpaceNewLine){L.push("trailing-space-new-line")}else{if(M.trailingSpace){L.push("trailing-space-"+(M.trailingSpace%2?"a":"b"))}}return L.length?L.join(" "):null}function c(K,J){if(K.match(h,true)){return x(J)}return undefined}function u(O,N){var Z=N.text(O,N);if(typeof Z!=="undefined"){return Z}if(N.list){N.list=null;return x(N)}if(N.taskList){var V=O.match(C,true)[1]!=="x";if(V){N.taskOpen=true}else{N.taskClosed=true}if(n.highlightFormatting){N.formatting="task"}N.taskList=false;return x(N)}N.taskOpen=false;N.taskClosed=false;if(N.header&&O.match(/^#+$/,true)){if(n.highlightFormatting){N.formatting="header"}return x(N)}var J=O.sol();var T=O.next();if(N.linkTitle){N.linkTitle=false;var Y=T;if(T==="("){Y=")"}Y=(Y+"").replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1");var K="^\\s*(?:[^"+Y+"\\\\]+|\\\\\\\\|\\\\.)"+Y;if(O.match(new RegExp(K),true)){return p.linkHref}}if(T==="`"){var X=N.formatting;if(n.highlightFormatting){N.formatting="code"}O.eatWhile("`");var Q=O.current().length;if(N.code==0){N.code=Q;return x(N)}else{if(Q==N.code){var U=x(N);N.code=0;return U}else{N.formatting=X;return x(N)}}}else{if(N.code){return x(N)}}if(T==="\\"){O.next();if(n.highlightFormatting){var L=x(N);var S=p.formatting+"-escape";return L?L+" "+S:S}}if(T==="!"&&O.match(/\[[^\]]*\] ?(?:\(|\[)/,false)){O.match(/\[[^\]]*\]/);N.inline=N.f=i;return p.image}if(T==="["&&O.match(/[^\]]*\](\(.*\)| ?\[.*?\])/,false)){N.linkText=true;if(n.highlightFormatting){N.formatting="link"}return x(N)}if(T==="]"&&N.linkText&&O.match(/\(.*?\)| ?\[.*?\]/,false)){if(n.highlightFormatting){N.formatting="link"}var L=x(N);N.linkText=false;N.inline=N.f=i;return L}if(T==="<"&&O.match(/^(https?|ftps?):\/\/(?:[^\\>]|\\.)+>/,false)){N.f=N.inline=B;if(n.highlightFormatting){N.formatting="link"}var L=x(N);if(L){L+=" "}else{L=""}return L+p.linkInline}if(T==="<"&&O.match(/^[^> \\]+@(?:[^\\>]|\\.)+>/,false)){N.f=N.inline=B;if(n.highlightFormatting){N.formatting="link"}var L=x(N);if(L){L+=" "}else{L=""}return L+p.linkEmail}if(T==="<"&&O.match(/^(!--|\w)/,false)){var M=O.string.indexOf(">",O.pos);if(M!=-1){var W=O.string.substring(O.start,M);if(/markdown\s*=\s*('|"){0,1}1('|"){0,1}/.test(W)){N.md_inside=true}}O.backUp(1);N.htmlState=a.startState(j);return v(O,N,z)}if(T==="<"&&O.match(/^\/\w*?>/)){N.md_inside=false;return"tag"}var R=false;if(!n.underscoresBreakWords){if(T==="_"&&O.peek()!=="_"&&O.match(/(\w)/,false)){var P=O.pos-2;if(P>=0){var aa=O.string.charAt(P);if(aa!=="_"&&aa.match(/(\w)/,false)){R=true}}}}if(T==="*"||(T==="_"&&!R)){if(J&&O.peek()===" "){}else{if(N.strong===T&&O.eat(T)){if(n.highlightFormatting){N.formatting="strong"}var U=x(N);N.strong=false;return U}else{if(!N.strong&&O.eat(T)){N.strong=T;if(n.highlightFormatting){N.formatting="strong"}return x(N)}else{if(N.em===T){if(n.highlightFormatting){N.formatting="em"}var U=x(N);N.em=false;return U}else{if(!N.em){N.em=T;if(n.highlightFormatting){N.formatting="em"}return x(N)}}}}}}else{if(T===" "){if(O.eat("*")||O.eat("_")){if(O.peek()===" "){return x(N)}else{O.backUp(1)}}}}if(n.strikethrough){if(T==="~"&&O.eatWhile(T)){if(N.strikethrough){if(n.highlightFormatting){N.formatting="strikethrough"}var U=x(N);N.strikethrough=false;return U}else{if(O.match(/^[^\s]/,false)){N.strikethrough=true;if(n.highlightFormatting){N.formatting="strikethrough"}return x(N)}}}else{if(T===" "){if(O.match(/^~~/,true)){if(O.peek()===" "){return x(N)}else{O.backUp(2)}}}}}if(T===" "){if(O.match(/ +$/,false)){N.trailingSpace++}else{if(N.trailingSpace){N.trailingSpaceNewLine=true}}}return x(N)}function B(M,L){var K=M.next();if(K===">"){L.f=L.inline=u;if(n.highlightFormatting){L.formatting="link"}var J=x(L);if(J){J+=" "}else{J=""}return J+p.linkInline}M.match(/^[^>]+/,true);return p.linkInline}function i(L,K){if(L.eatSpace()){return null}var J=L.next();if(J==="("||J==="["){K.f=K.inline=k(J==="("?")":"]",0);if(n.highlightFormatting){K.formatting="link-string"}K.linkHref=true;return x(K)}return"error"}var e={")":/^(?:[^\\\(\)]|\\.|\((?:[^\\\(\)]|\\.)*\))*?(?=\))/,"]":/^(?:[^\\\[\]]|\\.|\[(?:[^\\\[\\]]|\\.)*\])*?(?=\])/};function k(J){return function(N,M){var L=N.next();if(L===J){M.f=M.inline=u;if(n.highlightFormatting){M.formatting="link-string"}var K=x(M);M.linkHref=false;return K}N.match(e[J]);M.linkHref=true;return x(M)}}function l(K,J){if(K.match(/^([^\]\\]|\\.)*\]:/,false)){J.f=G;K.next();if(n.highlightFormatting){J.formatting="link"}J.linkText=true;return x(J)}return g(K,J,u)}function G(L,K){if(L.match(/^\]:/,true)){K.f=K.inline=b;if(n.highlightFormatting){K.formatting="link"}var J=x(K);K.linkText=false;return J}L.match(/^([^\]\\]|\\.)+/,true);return p.linkText}function b(K,J){if(K.eatSpace()){return null}K.match(/^[^\s]+/,true);if(K.peek()===undefined){J.linkTitle=true}else{K.match(/^(?:\s+(?:"(?:[^"\\]|\\\\|\\.)+"|'(?:[^'\\]|\\\\|\\.)+'|\((?:[^)\\]|\\\\|\\.)+\)))?/,true)}J.f=J.inline=u;return p.linkHref+" url"}var q={startState:function(){return{f:m,prevLine:null,thisLine:null,block:m,htmlState:null,indentation:0,inline:u,text:c,formatting:false,linkText:false,linkHref:false,linkTitle:false,code:0,em:false,strong:false,header:0,hr:false,taskList:false,list:false,listStack:[],quote:0,trailingSpace:0,trailingSpaceNewLine:false,strikethrough:false,fencedChars:null}},copyState:function(J){return{f:J.f,prevLine:J.prevLine,thisLine:J.thisLine,block:J.block,htmlState:J.htmlState&&a.copyState(j,J.htmlState),indentation:J.indentation,localMode:J.localMode,localState:J.localMode?a.copyState(J.localMode,J.localState):null,inline:J.inline,text:J.text,formatting:false,linkTitle:J.linkTitle,code:J.code,em:J.em,strong:J.strong,strikethrough:J.strikethrough,header:J.header,hr:J.hr,taskList:J.taskList,list:J.list,listStack:J.listStack.slice(0),quote:J.quote,indentedCode:J.indentedCode,trailingSpace:J.trailingSpace,trailingSpaceNewLine:J.trailingSpaceNewLine,md_inside:J.md_inside,fencedChars:J.fencedChars}},token:function(M,L){L.formatting=false;if(M!=L.thisLine){var J=L.header||L.hr;L.header=0;L.hr=false;if(M.match(/^\s*$/,true)||J){r(L);if(!J){return null}L.prevLine=null}L.prevLine=L.thisLine;L.thisLine=M;L.taskList=false;L.trailingSpace=0;L.trailingSpaceNewLine=false;L.f=L.block;var K=M.match(/^\s*/,true)[0].replace(/\t/g,"    ").length;L.indentationDiff=Math.min(K-L.indentation,4);L.indentation=L.indentation+L.indentationDiff;if(K>0){return null}}return L.f(M,L)},innerMode:function(J){if(J.block==z){return{state:J.htmlState,mode:j}}if(J.localState){return{state:J.localState,mode:J.localMode}}return{state:J,mode:q}},blankLine:r,getType:x,fold:"markdown"};return q},"xml");a.defineMIME("text/x-markdown","markdown")});